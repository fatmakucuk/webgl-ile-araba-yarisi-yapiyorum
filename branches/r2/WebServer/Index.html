<!DOCTYPE html>
<html>
<head>
<title>WebGL ile Araba Yarışı Yapıyorum</title>
<script src="libs/jquery.min.js"></script>
<script src="libs/can.jquery.min.js"></script>
<script src="libs/three.min.js"></script>
<script src="libs/threex.KeyboardState.js"></script>
<script src="libs/RequestAnimationFrame.js"></script>

<script>

    var container, renderer, scene, perspectiveCamera, keyboardState, car;

    $(function ()
    {
        BuildScene();

        AddPerspectiveCamera();

        AddSkyBoxAndFog();

        AddGround();

        AddLights();

        GetKeyboardState();

        AddCar();

        Animate();
    });

    function AddCar()
    {
        car = new THREE.Object3D();

        var jsonLoader = new THREE.JSONLoader();

        jsonLoader.load("models/CarBody.js", CarBodyLoaded);

        jsonLoader.load("models/CarWheel.js", CarWheelLoaded);

        car.position.set(0, 1.07, 0);

        car.rotateOnAxis(new THREE.Vector3(0, 1, 0), Math.PI / 4);

        scene.add(car);
    }

    function CarBodyLoaded(geometry, materials)
    {
        var material = new THREE.MeshFaceMaterial(materials);

        var carBody = new THREE.Mesh(geometry, material);

        carBody.position.set(0, 0, 0);

        carBody.castShadow = true;

        car.add(carBody);
    }

    function CarWheelLoaded(geometry, materials)
    {
        var material = new THREE.MeshFaceMaterial(materials);

        var frontLeftWheel = new THREE.Mesh(geometry, material);

        frontLeftWheel.position.set(-1, -0.72, -1.5);

        frontLeftWheel.castShadow = true;

        car.add(frontLeftWheel);

        var frontRightWheel = new THREE.Mesh(geometry.clone(), material);

        frontRightWheel.position.set(1, -0.72, -1.5);

        frontRightWheel.castShadow = true;

        car.add(frontRightWheel);

        var backLeftWheel = new THREE.Mesh(geometry, material);

        backLeftWheel.position.set(-1, -0.72, 1.5);

        backLeftWheel.castShadow = true;

        car.add(backLeftWheel);

        var backRightWheel = new THREE.Mesh(geometry.clone(), material);

        backRightWheel.position.set(1, -0.72, 1.5);

        backRightWheel.castShadow = true;

        car.add(backRightWheel);
    }

    function AnimationOperations()
    {
        var directionForward = false;
        var directionBack = false;

        if (keyboardState.pressed("up"))
        {
            car.translateZ(-0.25);

            directionForward = true;
        }

        if (keyboardState.pressed("down"))
        {
            car.translateZ(0.25);

            directionBack = true;
        }

        if (directionForward && !directionBack || !directionForward && directionBack)
        {
            if (keyboardState.pressed("left"))
            {
                var angle = Math.PI / 180;

                if (directionBack)
                {
                    angle *= -1;
                }

                car.rotateOnAxis(new THREE.Vector3(0, 1, 0), angle);
            }

            if (keyboardState.pressed("right"))
            {
                var angle = -1 * Math.PI / 180;

                if (directionBack)
                {
                    angle *= -1;
                }

                car.rotateOnAxis(new THREE.Vector3(0, 1, 0), angle);
            }
        }
    }

    function Animate()
    {
        AnimationOperations();

        renderer.render(scene, perspectiveCamera);

        requestAnimationFrame(Animate);
    }

    function BuildScene()
    {
        container = $("#Container");

        renderer = new THREE.WebGLRenderer({ antialias: true });

        renderer.setSize(container.width(), container.height());

        renderer.shadowMapEnabled = true;


        container.append(renderer.domElement);

        scene = new THREE.Scene();
    }

    function AddPerspectiveCamera()
    {
        var aspectRatio = container.width() / container.height();

        perspectiveCamera = new THREE.PerspectiveCamera(45, aspectRatio, 0.01, 2000);

        perspectiveCamera.position.set(0, 10, 20);

        perspectiveCamera.lookAt(new THREE.Vector3(0, 5, 0));
    }

    function AddSkyBoxAndFog()
    {
        var skyBox = new THREE.Mesh(new THREE.CubeGeometry(2000, 2000, 2000),
                                    new THREE.MeshBasicMaterial({ color: 0xe0eeee, side: THREE.BackSide }));

        scene.add(skyBox);


        scene.fog = new THREE.FogExp2(0xe0eeee, 0.00025);
    }

    function AddGround()
    {
        var ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000, 1, 1),
                                    new THREE.MeshLambertMaterial({ color: 0x222222 }));

        ground.position.set(0, -0.5, 0);

        ground.rotation.x = -1 * Math.PI / 2;

        ground.receiveShadow = true;

        scene.add(ground);
    }

    function AddLights()
    {
        var hemisphereLight = new THREE.HemisphereLight(0x454545, 0x454545, 2);

        scene.add(hemisphereLight);

        var spotLight = new THREE.SpotLight(0xffffff, 0.5);

        spotLight.position.set(0, 150, 150);

        spotLight.target.position.set(0, 0, 0);

        spotLight.castShadow = true;

        spotLight.shadowDarkness = 0.7;

        scene.add(spotLight);
    }

    function GetKeyboardState()
    {
        keyboardState = new THREEx.KeyboardState();
    }

</script>
</head>
<body>
<div id="Container" style="position: absolute; left: 0px; top: 0px; width: 100%; height: 100%; overflow: hidden;"></div>
</body>
</html>
